---
import BaseLayout from "./BaseLayout.astro"
import Nav from "../components/nav/Nav.astro"
import Footer from "../components/sections/Footer.astro"
import { calculateReadingTime, formatReadingTime } from "../utils/readingTime"

type Props = {
    title: string
    description: string
    publishedAt: Date
    updatedAt?: Date
    author: string
    coverImage?: string
    coverImageAlt?: string
    tags?: string[]
    slug: string
    body?: string
}

const {
    title,
    description,
    publishedAt,
    updatedAt,
    author,
    coverImage,
    coverImageAlt,
    tags = [],
    slug,
    body = "",
} = Astro.props

const readingTime = calculateReadingTime(body)

const formattedDate = publishedAt.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
})

const formattedUpdatedDate = updatedAt?.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
})

const canonicalPath = `/blog/${slug}`
const canonicalUrl = new URL(canonicalPath, Astro.site).toString()
const ogImagePath = coverImage || "/og.jpg"
const ogImageUrl = new URL(ogImagePath, Astro.site).toString()

// Build article meta tags
const metaLines: string[] = []
metaLines.push('<meta property="article:published_time" content="' + publishedAt.toISOString() + '" />')
if (updatedAt) {
    metaLines.push('<meta property="article:modified_time" content="' + updatedAt.toISOString() + '" />')
}
metaLines.push('<meta property="article:author" content="' + author + '" />')
for (const tag of tags) {
    metaLines.push('<meta property="article:tag" content="' + tag + '" />')
}

// JSON-LD structured data for Article
const articleJsonLd = {
    "@context": "https://schema.org",
    "@type": "Article",
    headline: title,
    description: description,
    image: ogImageUrl,
    datePublished: publishedAt.toISOString(),
    dateModified: (updatedAt || publishedAt).toISOString(),
    author: {
        "@type": "Organization",
        name: author,
        url: "https://duetmail.com",
    },
    publisher: {
        "@type": "Organization",
        name: "Duet Mail",
        url: "https://duetmail.com",
        logo: {
            "@type": "ImageObject",
            url: "https://duetmail.com/favicon.svg",
        },
    },
    mainEntityOfPage: {
        "@type": "WebPage",
        "@id": canonicalUrl,
    },
    keywords: tags.join(", "),
}

// JSON-LD structured data for Breadcrumbs
const breadcrumbJsonLd = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: "https://duetmail.com",
        },
        {
            "@type": "ListItem",
            position: 2,
            name: "Blog",
            item: "https://duetmail.com/blog/",
        },
        {
            "@type": "ListItem",
            position: 3,
            name: title,
            item: canonicalUrl,
        },
    ],
}

const jsonLdScript = '<script type="application/ld+json">' + JSON.stringify(articleJsonLd) + '<' + '/script>' +
    '<script type="application/ld+json">' + JSON.stringify(breadcrumbJsonLd) + '<' + '/script>'
const extraHeadHtml = metaLines.join("\n") + "\n" + jsonLdScript
---

<BaseLayout
    title={`${title} | Duet Mail Blog`}
    description={description}
    canonicalPath={canonicalPath}
    ogImagePath={ogImagePath}
    ogType="article"
    extraHeadHtml={extraHeadHtml}
>
    <Nav />

    <!-- Reading Progress Indicator -->
    <div class="reading-progress" id="reading-progress">
        <div class="reading-progress-bar" id="reading-progress-bar"></div>
    </div>

    <main class="blog-post">
        <article class="blog-article">
            <!-- Article Header -->
            <header class="article-header">
                <nav class="article-nav">
                    <a href="/blog" class="article-back">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                            <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Back to Journal</span>
                    </a>
                </nav>

                <div class="article-meta-top">
                    <time datetime={publishedAt.toISOString()} class="article-date">
                        {formattedDate}
                    </time>
                    <span class="article-meta-dot" aria-hidden="true"></span>
                    <span class="article-reading-time">
                        {formatReadingTime(readingTime)}
                    </span>
                </div>

                <h1 class="article-title">{title}</h1>

                <p class="article-description">{description}</p>

                {(author !== "Duet Mail Team" || formattedUpdatedDate) && (
                    <div class="article-byline">
                        {author !== "Duet Mail Team" && (
                            <span class="article-author">By {author}</span>
                        )}
                        {author !== "Duet Mail Team" && formattedUpdatedDate && (
                            <span class="article-meta-dot" aria-hidden="true"></span>
                        )}
                        {formattedUpdatedDate && (
                            <span class="article-updated">Updated {formattedUpdatedDate}</span>
                        )}
                    </div>
                )}
            </header>

            <!-- Cover Image -->
            {coverImage && (
                <figure class="article-cover">
                    <img
                        src={coverImage}
                        alt={coverImageAlt || title}
                        class="article-cover-image"
                        loading="eager"
                        decoding="async"
                    />
                </figure>
            )}

            <!-- Article Content -->
            <div class="article-content duet-prose duet-prose--dropcap">
                <slot />
            </div>

            <!-- Article Footer -->
            <footer class="article-footer">
                <!-- Tags (if any) -->
                {tags.length > 0 && (
                    <div class="article-tags">
                        <span class="article-tags-label">Topics</span>
                        <div class="article-tags-list">
                            {tags.map((tag) => (
                                <span class="article-tag">{tag}</span>
                            ))}
                        </div>
                    </div>
                )}

                <!-- Divider -->
                <div class="article-divider">
                    <span class="article-divider-ornament"></span>
                </div>

                <!-- CTA Section -->
                <div class="article-cta">
                    <h2 class="article-cta-title">Transform your inbox</h2>
                    <p class="article-cta-text">
                        Join thousands of professionals who've reclaimed their time with AI-powered email management.
                    </p>
                    <a href="https://app.duetmail.com" class="article-cta-button">
                        Get started free
                    </a>
                </div>

                <!-- Back Link -->
                <div class="article-footer-nav">
                    <a href="/blog" class="article-back article-back--footer">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                            <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Back to Journal</span>
                    </a>
                </div>
            </footer>
        </article>
    </main>
    <Footer />
</BaseLayout>

<script>
    // Reading progress indicator
    const progressBar = document.getElementById('reading-progress-bar')
    const article = document.querySelector('.article-content')

    if (progressBar && article) {
        const updateProgress = () => {
            const articleRect = article.getBoundingClientRect()
            const articleTop = articleRect.top + window.scrollY
            const articleHeight = articleRect.height
            const windowHeight = window.innerHeight
            const scrollY = window.scrollY

            // Calculate progress based on how much of the article has been scrolled past
            const startReading = articleTop - windowHeight * 0.3
            const endReading = articleTop + articleHeight - windowHeight * 0.7
            const readingRange = endReading - startReading

            let progress = 0
            if (scrollY > startReading) {
                progress = Math.min(100, ((scrollY - startReading) / readingRange) * 100)
            }

            progressBar.style.width = `${progress}%`
        }

        window.addEventListener('scroll', updateProgress, { passive: true })
        updateProgress()
    }
</script>

<style>
    /* Reading Progress */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: transparent;
        z-index: 1000;
    }

    .reading-progress-bar {
        height: 100%;
        width: 0%;
        background: var(--prose-link);
        transition: width 50ms ease-out;
    }

    /* Main Layout */
    .blog-post {
        min-height: 100vh;
        padding-top: 100px;
        padding-bottom: 120px;
    }

    .blog-article {
        max-width: 720px;
        margin: 0 auto;
        padding: 0 24px;
    }

    @media (min-width: 768px) {
        .blog-article {
            padding: 0 32px;
        }
    }

    /* Article Navigation */
    .article-nav {
        margin-bottom: 48px;
    }

    .article-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 500;
        letter-spacing: 0.02em;
        color: var(--duet-muted);
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .article-back:hover {
        color: var(--prose-heading);
    }

    .article-back svg {
        transition: transform 0.2s ease;
    }

    .article-back:hover svg {
        transform: translateX(-2px);
    }

    /* Article Header */
    .article-header {
        text-align: center;
        margin-bottom: 56px;
    }

    @media (min-width: 768px) {
        .article-header {
            margin-bottom: 72px;
        }
    }

    .article-meta-top {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 24px;
    }

    .article-date,
    .article-reading-time {
        font-size: 13px;
        font-weight: 500;
        color: var(--duet-muted);
        letter-spacing: 0.02em;
    }

    .article-meta-dot {
        width: 3px;
        height: 3px;
        background: var(--duet-muted);
        border-radius: 50%;
        opacity: 0.5;
    }

    .article-title {
        font-family: var(--font-serif);
        font-size: 40px;
        font-weight: 500;
        line-height: 1.15;
        letter-spacing: -0.03em;
        color: var(--prose-heading);
        margin: 0 0 24px;
        text-wrap: balance;
    }

    @media (min-width: 768px) {
        .article-title {
            font-size: 48px;
        }
    }

    .article-description {
        font-size: 18px;
        line-height: 1.6;
        color: var(--prose-text);
        margin: 0 0 28px;
        text-wrap: pretty;
        max-width: 580px;
        margin-left: auto;
        margin-right: auto;
    }

    @media (min-width: 768px) {
        .article-description {
            font-size: 20px;
        }
    }

    .article-byline {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 14px;
        color: var(--duet-muted);
    }

    .article-author {
        font-weight: 600;
        color: var(--prose-text);
    }

    .article-updated {
        font-style: italic;
    }

    /* Cover Image */
    .article-cover {
        margin: 0 -24px 56px;
        padding: 0;
    }

    @media (min-width: 768px) {
        .article-cover {
            margin: 0 -64px 72px;
        }
    }

    .article-cover-image {
        display: block;
        width: 100%;
        height: auto;
        aspect-ratio: 16 / 9;
        object-fit: cover;
        border-radius: 12px;
    }

    @media (min-width: 768px) {
        .article-cover-image {
            border-radius: 16px;
        }
    }

    /* Article Content */
    .article-content {
        font-size: 17px;
        line-height: 1.85;
    }

    /* Hide duplicate title - many posts repeat the title as first H1 in markdown */
    .article-content > :global(h1:first-child) {
        display: none;
    }

    .article-content :global(h2:first-child),
    .article-content :global(h3:first-child) {
        margin-top: 0;
    }

    .article-content :global(img) {
        display: block;
        max-width: calc(100% + 48px);
        margin-left: -24px;
        margin-right: -24px;
        height: auto;
        border-radius: 12px;
    }

    @media (min-width: 768px) {
        .article-content :global(img) {
            max-width: calc(100% + 128px);
            margin-left: -64px;
            margin-right: -64px;
            border-radius: 16px;
        }
    }

    .article-content :global(figure) {
        margin: 2.5em -24px;
    }

    @media (min-width: 768px) {
        .article-content :global(figure) {
            margin: 3em -64px;
        }
    }

    .article-content :global(figure img) {
        margin: 0;
        max-width: 100%;
    }

    .article-content :global(figcaption) {
        margin-top: 16px;
        padding: 0 24px;
        font-size: 14px;
        line-height: 1.5;
        color: var(--prose-text-secondary);
        text-align: center;
        font-style: italic;
    }

    @media (min-width: 768px) {
        .article-content :global(figcaption) {
            padding: 0 64px;
        }
    }

    /* Article Footer */
    .article-footer {
        margin-top: 80px;
    }

    /* Tags */
    .article-tags {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin-bottom: 48px;
    }

    .article-tags-label {
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--duet-muted);
    }

    .article-tags-list {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
    }

    .article-tag {
        display: inline-flex;
        padding: 6px 14px;
        font-size: 13px;
        font-weight: 500;
        color: var(--prose-text);
        background: color-mix(in srgb, var(--duet-border) 150%, transparent);
        border-radius: 20px;
        transition: background 0.2s ease;
    }

    /* Divider */
    .article-divider {
        display: flex;
        justify-content: center;
        margin: 48px 0;
    }

    .article-divider-ornament {
        position: relative;
        width: 120px;
        height: 1px;
        background: var(--duet-border-editorial);
    }

    .article-divider-ornament::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 6px;
        height: 6px;
        background: var(--duet-bg);
        border: 1px solid var(--duet-border-editorial);
        border-radius: 50%;
    }

    /* CTA Section */
    .article-cta {
        text-align: center;
        padding: 48px 32px;
        background: color-mix(in srgb, var(--duet-border) 80%, transparent);
        border-radius: 16px;
        margin-bottom: 40px;
    }

    .article-cta-title {
        font-family: var(--font-serif);
        font-size: 24px;
        font-weight: 500;
        letter-spacing: -0.02em;
        color: var(--prose-heading);
        margin: 0 0 12px;
    }

    .article-cta-text {
        font-size: 15px;
        line-height: 1.6;
        color: var(--prose-text);
        margin: 0 0 24px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .article-cta-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 14px 32px;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.01em;
        color: #ffffff;
        background: var(--prose-heading);
        border-radius: 8px;
        text-decoration: none;
        transition:
            transform 0.2s ease,
            opacity 0.2s ease;
    }

    .article-cta-button:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }

    /* Footer Navigation */
    .article-footer-nav {
        display: flex;
        justify-content: center;
        padding-top: 24px;
    }

    .article-back--footer {
        margin: 0;
    }
</style>
