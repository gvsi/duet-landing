name: Codex Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  codex:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      final_message: ${{ steps.codex.outputs.final-message }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Run Codex Code Review
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.AZURE_OPENAI_API_KEY }}
          responses-api-endpoint: https://me-m9ubezmx-eastus2.openai.azure.com/openai/v1/responses
          model: gpt-5.2
          effort: xhigh
          prompt: |
            Review ONLY the changes introduced by this pull request — do NOT review the entire codebase.

            Base branch: origin/${{ github.event.pull_request.base.ref }}
            Head SHA: ${{ github.event.pull_request.head.sha }}

            To see the changes, run: git diff origin/${{ github.event.pull_request.base.ref }}...HEAD

            ## Review Guidelines

            Only report issues you are highly confident about. Do not speculate or flag
            hypothetical problems. If a finding is uncertain, omit it. Prioritize a short,
            actionable review over an exhaustive one — fewer high-quality findings are better
            than many low-confidence ones.

            Do NOT run tests — a separate CI job handles that. Focus on static analysis of
            the diff only.

            Analyze the diff across these dimensions:

            ### 1. Correctness & Logic
            - Verify the code accomplishes its intended purpose
            - Identify logical errors, off-by-one errors, and incorrect assumptions
            - Check edge cases and boundary conditions
            - Validate error handling covers failure scenarios
            - Ensure async operations are properly awaited and errors propagated

            ### 2. Security
            - Identify potential vulnerabilities (injection, XSS, CSRF, etc.)
            - Check for proper input validation and sanitization
            - Verify sensitive data handling (tokens, credentials, PII)
            - Look for hardcoded secrets or credentials

            ### 3. Performance
            - Identify inefficient algorithms or data structures
            - Look for N+1 query problems or unnecessary database calls
            - Check for missing memoization or caching opportunities
            - Identify potential memory leaks or resource exhaustion

            ### 4. Code Quality & Maintainability
            - Evaluate adherence to DRY principles
            - Check for appropriate abstraction levels
            - Verify naming conventions are clear and consistent
            - Look for overly complex logic that could be simplified

            ### 5. Testing Considerations (do not execute tests)
            - Identify untested code paths in the changes
            - Suggest specific test cases that should be added

            ## Output Format

            **Summary**: 1-2 sentence overall assessment.

            **Critical Issues** (must fix):
            - Bugs, security vulnerabilities, or breaking issues with file/line references and suggested fixes

            **Recommendations** (should fix):
            - Improvements with explanations and example code when helpful

            **Minor Suggestions** (optional):
            - Style preferences or alternative approaches

            **Strengths**:
            - Good patterns and practices worth acknowledging

            If there are no issues, say so clearly. Be specific with file and line references.
            Every criticism must include a suggested fix.

  post_feedback:
    runs-on: ubuntu-latest
    needs: codex
    if: needs.codex.outputs.final_message != ''
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Post Codex Review Comment
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.codex.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: process.env.CODEX_FINAL_MESSAGE,
            });
